<?xml version="1.0" encoding="UTF-8" ?>

<project name="genjar2-test" basedir=".">

    <property name="target-jar" value="build/${ant.project.name}-tmp.jar" />

    <target name="init">
        <taskdef file="../etc/genjar.properties">
            <classpath location="../build" />
        </taskdef>
        <mkdir dir="build/lib" />
    </target>

    <!--
    ============================================================================
        Remove all files generated by build process.
    ============================================================================
    -->
    <target name="clean">
        <delete includeEmptyDirs="true" failonerror="false">
            <fileset dir="build">
                <exclude name="classes/**/*" />
                <include name="**/*" />
            </fileset>
        </delete>
    </target>

    <!-- Tests attempt use task with out destfile or destdir attribute -->
    <target name="test.ex.1" depends="init">
        <genjar />
    </target>

    <!-- Tests attempt to load file attribute and fileset for same resource element -->
    <target name="test.ex.2" depends="init">
        <genjar destfile="${target-jar}">
            <fileset file="package2">
                <fileset dir="etc" includes="*" />
            </fileset>
        </genjar>
    </target>

    <!-- Tests attempt to specify both a file and dir for the zipfileset element. -->
    <target name="test.ex.3" depends="init">
        <genjar destfile="${target-jar}">
            <zipfileset src="etc/xbean_xpath.jar" dir="build/lib" />
        </genjar>
    </target>

    <!-- Tests simple class dependency building -->
    <target name="test.class.1" depends="init">
        <genjar destfile="${target-jar}">
            <class name="package1.Class2" />
            <classpath location="../build" />
        </genjar>
    </target>

    <!-- Tests class dependency building with classes as method params -->
    <target name="test.class.2" depends="init">
        <genjar destfile="${target-jar}">
            <class name="package2.Class5" />
            <classpath location="../build" />
        </genjar>
    </target>

    <!-- Tests class dependency building with a fileset in <class> -->
    <target name="test.class.3" depends="init">
        <genjar destfile="${target-jar}">
            <class>
                <fileset dir="../build" includes="package1/*" />
            </class>
            <classpath location="../build" />
        </genjar>
    </target>

    <!-- Tests class dependency building with inner classes -->
    <target name="test.class.4" depends="init">
        <genjar destfile="${target-jar}">
            <class name="package3.Class7" />
            <classpath location="../build" />
        </genjar>
    </target>

    <!-- Tests the include / exclude for classfilters -->
    <target name="test.classfilter.1" depends="init">
        <genjar destfile="${target-jar}">
            <class name="package1.Class3" />
            <classpath location="../build" />
            <classpath location="${java.home}/lib/rt.jar" />
            <classfilter>
                <include name="java.util.ArrayList" />
                <exclude name="package2" />
            </classfilter>
        </genjar>
    </target>

    <!-- Tests the include / exclude for classfilters -->
    <target name="test.classfilter.2" depends="init">
        <property name="flag1" value="true" />
        <genjar destfile="${target-jar}">
            <class name="package1.Class3" />
            <classpath location="../build" />
            <classpath location="${java.home}/lib/rt.jar" />
            <classfilter>
                <include name="java.util.ArrayList" unless="flag1" />
                <exclude name="package2" if="flag2" />
                <exclude name="package1.Class2" if="flag1" />
            </classfilter>
        </genjar>
    </target>

    <!-- Tests the fileset 'includes' and 'excludes' attributes -->
    <target name="test.fileset.1" depends="init">
        <genjar destfile="${target-jar}">
            <class name="package1.Class1" />
            <classpath location="../build" />

            <fileset dir="../etc" includes="genjar.properties" />
            <fileset dir="etc" includes="file.properties" />
            <fileset dir="src" includes="**/*.png" excludes="**/sawfish-m*.png" />
        </genjar>
    </target>

    <!-- Tests fileset elements with file attributes -->
    <target name="test.fileset.2" depends="init">
        <genjar destfile="${target-jar}">
            <class name="package1.Class1" />
            <classpath location="../build" />
            <fileset file="../etc/genjar.properties" />
            <fileset file="etc/file.properties" />
            <fileset file="src/package1/imagedir1/sawfish-logo.png" />
        </genjar>
    </target>

    <!-- Tests zipfileset file inclusion to jar with duplicate entries and jar index creation -->
    <target name="test.zipfileset.1" depends="init">
        <genjar destfile="${target-jar}" filesetmanifest="merge">
            <class name="package1.Class3" />
            <classpath location="../build" />
            <zipfileset src="etc/test1.zip" />
            <zipfileset src="etc/xbean_xpath.jar" />
        </genjar>
    </target>

    <!-- Tests the zipfileset 'includes' attribute -->
    <target name="test.zipfileset.2" depends="init">
        <genjar destfile="${target-jar}">
            <class name="package1.Class3" />
            <classpath location="../build" />
            <zipfileset src="etc/xbean_xpath.jar" includes="**/XBeansX*.class" />
        </genjar>
    </target>

    <!-- Tests the zipfileset 'excludes' attribute -->
    <target name="test.zipfileset.3" depends="init">
        <genjar destfile="${target-jar}">
            <class name="package1.Class3" />
            <classpath location="../build" />
            <zipfileset src="etc/xbean_xpath.jar" excludes="**/XBeansX.class" />
        </genjar>
    </target>

    <!-- Tests including a required jar using zipfileset. If we're including the 
         entire jar, the build should succeed even if the jar isn't listed 
         explicitly in the classpath -->
    <target name="test.zipfileset.4" depends="init">
        <genjar destfile="${target-jar}">
            <class name="package4.Class8" />
            <classpath location="." />
            <zipfileset src="etc/test3.jar" includes="package4/**/*.class" />
        </genjar>
    </target>

    <!-- Tests zipgroupfileset inclusion -->
    <target name="test.zipgroupfileset.1" depends="init">
        <genjar destfile="${target-jar}">
            <class name="package1.Class3" />
            <classpath location="../build" />
            <zipgroupfileset dir="etc" includes="test1.zip,test2.jar" />
        </genjar>
    </target>

    <!-- Tests zipgroupfileset including a jar with signatures in the manifest -->
    <target name="test.zipgroupfileset.2" depends="init">
        <genjar destfile="${target-jar}">
            <zipgroupfileset dir="etc" includes="test1.zip,xbean_xpath.jar" />
        </genjar>
    </target>

    <!-- Tests manifest generation -->
    <target name="test.manifest.1" depends="init">
        <genjar destfile="${target-jar}">
            <manifest>
                <attribute name="Built-By" value="${ant.project.name}" />
                <attribute name="Extension-name" value="${ant.project.name}" />
            </manifest>
        </genjar>
    </target>

    <!-- Tests manifest inclusion and merging -->
    <target name="test.manifest.2" depends="init">
        <genjar destfile="${target-jar}" manifest="etc/MANIFEST.MF1">
            <manifest>
                <attribute name="Built-By2" value="${ant.project.name}2" />
                <attribute name="Extension-name2" value="${ant.project.name}2" />
            </manifest>
        </genjar>
    </target>

    <!-- Tests the classpath resolvers, including specifying a jar file with an uppercase suffix -->
    <target name="test.classpath.1" depends="init">
        <genjar destfile="${target-jar}">
            <class name="package1.Class3" />
            <classpath location="etc/test3.JAR" />
        </genjar>
    </target>

    <!-- Ensures GenJar is not keeping files open (locked) -->
    <!-- This test only ever failed on Windows -->
    <target name="test.locking.1" depends="init">
        <mkdir dir="build/Lock" />
        <jar destfile="build/Lock/jar1.jar" includes="package1.Class1" basedir="../build" />
        <genjar jarfile="build/Lock/jar2.jar">
            <class name="package1.Class2" />
            <classpath>
                <pathelement location="build/Lock/jar1.jar" />
                <pathelement location="../build" />
            </classpath>
        </genjar>
        <delete file="build/Lock/jar1.jar" />
        <delete file="build/Lock/jar2.jar" />
    </target>

    <!-- Ensures that genjar can build itself -->
    <target name="test.genjar.jar" depends="init">
        <genjar destfile="build/genjar.jar">
            <class name="net.sf.genjar.GenJar" />
            <classpath>
                <pathelement location="../build" />
                <fileset dir="../lib" includes="**/*.jar" />
            </classpath>
            <classfilter>
                <include name="net.sf.genjar" />
                <exclude name="org.apache.tools.ant" />
            </classfilter>
            <fileset file="../etc/genjar.properties" />
        </genjar>
    </target>

    <!-- Tests generating a source jar to accompany the class-file jar -->
    <target name="test.srcjar.1" depends="test.genjar.jar">
        <srcjar destfile="${target-jar}" classjar="test/build/genjar.jar">
            <sourcepath location="../src" />
        </srcjar>
    </target>

    <!-- Profiles GenJar searching over a sizable jar classpath -->
    <target name="test.profile" depends="init">
        <genjar destfile="${target-jar}" update="false">
            <class name="profile.Foo" />
            <class name="profile.A" />

            <classpath location="build" />

            <classfilter>
                <include name="profile.Bar" />
                <exclude name="profile.A" />
            </classfilter>

            <fileset dir="src" includes="profile/Foo2.java" />
            <zipfileset src="lib/jsr173_api.jar" />
            <zipfileset src="lib/xmlschema-genjar.jar" />

            <manifest>
                <attribute name="Main-Class" value="genjar.Foo" />
            </manifest>
        </genjar>
    </target>

</project>
